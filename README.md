# О проекте

Проект тестирования работы AmoCRMApi в экосистеме фреймворка Laravel.

## Аутентификация

В системе два уровня аутентификации. Первый - уровень приложения, базовая аутентификация laravel, через middleware auth, занесение объектов модели User в БД. Далее, был создан middleware [token](https://github.com/DavidaaWoW/AmoCRMLeads/blob/master/app/Http/Middleware/TokenAccess.php), который отвечает за второй уровень аутентификации уже в системе AmoCRM. На данный момент, система oauth2 работает не так, как должна, т.к. для полноценной работы требуется публичный веб-сервер, а тестирование велось на локальном. Но в то же время, окружение полностью готово к его внедрению. Так, на данный момент, захардкожены пункты clientId, clientSecret и redirectUri, а пункты baseDomain и временный токен пользователь вводит на странице homepage. Однако, эти данные пользователю необходимо вводить лишь один раз, потому что присутствует middleware [tokenRefresh](https://github.com/DavidaaWoW/AmoCRMLeads/blob/master/app/Http/Middleware/TokenRefresh.php), который проверяет дату истечения accessToken-а, и в случае истечения, получает новый уже по refreshToken-у. Все эти данный хранятся в модели [User](https://github.com/DavidaaWoW/AmoCRMLeads/blob/master/app/Models/User.php).

## Миграции и БД

В качестве БД был использован PostgreSQL. Таблицы создавались внутри docker контейнера apache, путём выполнения команды ```php artisan migrate```. Для этого, была включена соответствующая настройка в файле php.ini, который был смонтирован внутрь образа, заменяя дефолтный конфиг. 
Всего было создано 3 таблицы - для пользователей, сделок и компаний, привязаных к сделкам. Между пользователями и сделками отношение один ко многим, это же отношение установлено между компаниями и сделками. В таблицы были внесены не все поля, приходящие в ответе Api, однако, при необходимости, они могут быть легко добавлены.

## Выгрузка сделок и компаний

Список всех сделок формируется на странице [leads](https://github.com/DavidaaWoW/AmoCRMLeads/blob/master/resources/views/leads.blade.php). На той же странице присутствует кнопка, для обновления списка сделок, которая отправляет запрос на [LeadsController](https://github.com/DavidaaWoW/AmoCRMLeads/blob/master/app/Http/Controllers/LeadsController.php). Система выгрузки и обновления была оптимизирована, с помощью добавления в модель пользователя поля ```latest_lead_update```, в которое записывается timestamp последнего обновления сделок (по умолчанию равен нулю). Далее, уже в самом контроллере создаётся ```rangefilter```, в который записывается промежуток времени между timestamp-ом в модели текущего пользователя и настоящим временем, что позволяет, получать в ответе API только новые сделки. После чего, в том же контроллере происходит аналогичная процедура, уже для обновления сделок, при этом по всему объекту сделки выполняется ```PUT``` запрос к БД.
Во время добавления новых сделок в БД, происходит проверка на существования привязанной к сделке компании, если её в БД нет, то отправляется запрос к API, на получение компании, которая далее и добавляется в БД, привязываясь к сделке.

В проекте присутствует навигация между страницами сделок и компании. На страницах можно уведеть основную информацию по всем моделям. Также, в контроллере, при вызове view, данные сделок передаются в отсортированном виде, по дате обновления, позволяя таким образом отображать новые изменения наверху страницы.
